<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CMGAP提字器</title>
    <style>
        :root {
            --harmony-scale: 1;
            --scroll-position: 0px;
        }
        
        body {
            font-family: -apple-system, "HarmonyOS Sans", BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            touch-action: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .header {
            background-color: #333;
            padding: 1px;
            text-align: center;
            flex-shrink: 0;
            height: 20px;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 16px;
            margin: 0;
            line-height: 28px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            padding: 2px;
            background-color: #444;
            gap: 3px;
            flex-wrap: wrap;
            flex-shrink: 0;
            height: auto;
            min-height: 20px;
        }
        
        button {
            padding: 3px 6px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            min-width: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 3px;
            background-color: #555;
            padding: 3px 3px;
            border-radius: 6px;
        }
        
        .teleprompter {
            flex: 1;
            overflow: hidden;
            position: relative;
            background-color: black;
            margin: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            touch-action: none;
        }
        
        .text-container {
            width: 96%;
            height: 96%;
            overflow: hidden;
            position: relative;
        }
        
        /* 主要修改：分离镜像和滚动控制 */
        #prompter-text {
            font-size: calc(28px * var(--harmony-scale));
            line-height: 1.8;
            color: white;
            position: absolute;
            width: 100%;
            text-align: center;
            transition: transform 0.1s linear;
            user-select: none;
            padding: 15px;
            box-sizing: border-box;
            font-weight: 500;
            will-change: transform;
            white-space: pre-line;
            text-indent: 2em;
            margin: 0;
            top: 0;
            left: 0;
            transform: translateY(var(--scroll-position, 0px));
        }
        
        /* 镜像模式 - 使用CSS变量分离镜像和滚动 */
        .text-container.mirror #prompter-text {
            transform: scaleX(-1) translateY(var(--scroll-position, 0px)) !important;
        }
        
        /* 备用定位方式类 */
        .use-top-positioning {
            transform: none !important;
            top: var(--text-position, 0px) !important;
        }
        
        /* 确保使用top定位时镜像模式也正常工作 */
        .text-container.mirror #prompter-text.use-top-positioning {
            transform: scaleX(-1) !important;
            top: var(--text-position, 0px) !important;
        }
        
        textarea {
            width: 96%;
            min-height: 60px;
            height: auto;
            margin: 5px auto;
            display: block;
            padding: 8px;
            font-size: 32px;
            border-radius: 6px;
            border: none;
            flex-shrink: 0;
            -webkit-appearance: none;
            background-color: white;
            color: black;
        }
        
        #file-input {
            display: none;
        }
        
        @media screen and (max-width: 360px) {
            #prompter-text {
                font-size: calc(22px * var(--harmony-scale));
            }
            button {
                padding: 8px 12px;
                min-width: 50px;
                font-size: 16px;
            }
        }

        @media screen and (orientation: landscape) {
            .header {
                display: none;
            }
            
            .header h1 {
                font-size: 16px;
                margin: 0;
                line-height: 28px;
            }

            .teleprompter {
                margin: 2px;
                height: calc(100vh - 60px);
                width: 70%;
                margin-left: auto;
                margin-right: auto;
            }
            
            .text-container {
                width: 100%;
                height: 98% !important;
            }
            
            #prompter-text {
                font-size: calc(26px * var(--harmony-scale));
                padding: 10px;
            }
            
            .controls {
                padding: 4px;
                gap: 4px;
            }
            
            .control-group {
                padding: 4px 5px;
            }
            
            button {
                padding: 8px 5px;
                min-width: 30px;
            }
            
            textarea {
                min-height: 50px;
                height: auto;
                margin: 3px auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CMGAP提字器</h1>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <button id="start-btn">开始</button>
            <button id="pause-btn" disabled>暂停</button>
            <button id="reset-btn">重置</button>
        </div>
        
        <div class="control-group">
            <label for="speed">速度:</label>
            <input type="range" id="speed" min="1" max="20" value="5">
            <span id="speed-value">5</span>
        </div>
        
        <div class="control-group">
            <label for="font-size">字体:</label>
            <input type="range" id="font-size" min="16" max="48" value="28">
            <span id="font-size-value">28px</span>
        </div>
        
        <div class="control-group">
            <button id="mirror-btn">镜像模式</button>
            <button id="open-file-btn">打开文件</button>
            <input type="file" id="file-input" accept=".txt,.text,.md,.markdown,.log,.csv,.json,.xml,.html,.htm">
        </div>
        
        <!-- 新增调试信息显示 -->
        <div class="control-group" id="debug-info" style="display: none; font-size: 12px; color: #ccc;">
            系统: <span id="system-info">检测中...</span>
        </div>
    </div>
    
    <div class="teleprompter" id="teleprompter-area">
        <div class="text-container" id="text-container">
            <div id="prompter-text">在这里输入您的文本。点击"开始"按钮开始滚动，使用速度滑块调整滚动速度。</div>
        </div>
    </div>
    
    <textarea id="input-text" placeholder="在此输入您的提词文本..."></textarea>
    
    <script>
        // 系统检测和兼容性配置
        const systemInfo = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            isAndroid: /Android/.test(navigator.userAgent),
            isHarmonyOS: /HarmonyOS|HMOS/.test(navigator.userAgent),
            isChrome: /Chrome/.test(navigator.userAgent),
            isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
            browser: navigator.userAgent
        };
        
        // 显示系统信息（调试用）
        document.getElementById('system-info').textContent = 
            `${systemInfo.isIOS ? 'iOS' : systemInfo.isAndroid ? 'Android' : systemInfo.isHarmonyOS ? 'HarmonyOS' : '其他'} | ${systemInfo.isSafari ? 'Safari' : systemInfo.isChrome ? 'Chrome' : '其他浏览器'}`;
        
        // 根据系统选择最佳滚动方案
        const useTopPositioning = systemInfo.isIOS; // iOS使用top定位，其他使用transform
        
        // 应用系统特定优化
        if (systemInfo.isHarmonyOS) {
            document.documentElement.style.setProperty('--harmony-scale', '1.1');
        }
        
        if (systemInfo.isIOS) {
            document.body.style.webkitUserSelect = 'none';
            document.body.style.webkitTouchCallout = 'none';
            // iOS使用top定位方案
            document.getElementById('prompter-text').classList.add('use-top-positioning');
        }
        
        // 获取DOM元素
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const mirrorBtn = document.getElementById('mirror-btn');
        const openFileBtn = document.getElementById('open-file-btn');
        const fileInput = document.getElementById('file-input');
        const speedSlider = document.getElementById('speed');
        const speedValue = document.getElementById('speed-value');
        const fontSizeSlider = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');
        const prompterText = document.getElementById('prompter-text');
        const inputText = document.getElementById('input-text');
        const textContainer = document.getElementById('text-container');
        const teleprompterArea = document.getElementById('teleprompter-area');
        
        // 初始化变量
        let isPlaying = false;
        let animationId;
        let position = 0;
        let speed = 5;
        let fontSize = 28;
        let touchStartY = 0;
        let touchStartPosition = 0;
        let isTouchMoving = false;
        let touchCount = 0;
        let lastTouchTime = 0;
        let textHeight = 0;
        let containerHeight = 0;
                
        // 更准确的高度计算函数
        function calculateHeights() {
            // 保存当前状态
            const currentPosition = position;
            
            // 临时重置位置以获取准确高度
            if (useTopPositioning) {
                prompterText.style.setProperty('--text-position', '0px');
            } else {
                prompterText.style.setProperty('--scroll-position', '0px');
            }
            
            // 强制重绘
            prompterText.offsetHeight;
            
            // 计算高度
            containerHeight = textContainer.clientHeight;
            textHeight = prompterText.scrollHeight;
            
            // 恢复位置
            updatePosition();
            
            console.log('高度计算 - 容器:', containerHeight, '文本:', textHeight, '系统:', systemInfo.isIOS ? 'iOS' : '其他');
        }
        
        // 兼容性位置更新函数
        function updatePosition() {
            // 限制位置范围
            const maxPosition = Math.max(0, textHeight - containerHeight);
            position = Math.max(0, Math.min(position, maxPosition));
            
            // 根据系统使用不同的定位方式
            if (useTopPositioning) {
                // iOS使用top定位
                prompterText.style.setProperty('--text-position', `-${position}px`);
            } else {
                // 其他系统使用transform，通过CSS变量控制
                prompterText.style.setProperty('--scroll-position', `-${position}px`);
            }
            
            // 检查是否滚动结束
            if (position >= maxPosition && isPlaying) {
                pauseScrolling();
                console.log('滚动完成');
            }
        }
        
        // 自动调整初始字体大小
        function adjustInitialFontSize() {
            const screenHeight = window.innerHeight;
            if (screenHeight < 600) {
                fontSize = 26;
            } else if (screenHeight > 800) {
                fontSize = 32;
            }
            fontSizeSlider.value = fontSize;
            prompterText.style.fontSize = fontSize + 'px';
            fontSizeValue.textContent = fontSize + 'px';
        }
        
        // 更新速度显示
        speedSlider.addEventListener('input', function() {
            speed = parseInt(this.value);
            speedValue.textContent = speed;
        });
        
        // 更新字体大小
        fontSizeSlider.addEventListener('input', function() {
            fontSize = parseInt(this.value);
            fontSizeValue.textContent = fontSize + 'px';
            prompterText.style.fontSize = fontSize + 'px';
            setTimeout(calculateHeights, 100);
        });
        
        // 开始滚动
        function startScrolling() {
            if (!isPlaying) {
                isPlaying = true;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                calculateHeights();
                animate();
            }
        }
        
        // 暂停滚动
        function pauseScrolling() {
            if (isPlaying) {
                isPlaying = false;
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                cancelAnimationFrame(animationId);
            }
        }
        
        startBtn.addEventListener('click', startScrolling);
        pauseBtn.addEventListener('click', pauseScrolling);
        
        // 重置位置
        resetBtn.addEventListener('click', function() {
            pauseScrolling();
            position = 0;
            updatePosition();
        });
        
        // 镜像模式 - 只对文本容器内的文本内容应用水平翻转
        mirrorBtn.addEventListener('click', function() {
            textContainer.classList.toggle('mirror');
            
            // 更新按钮文本以反映当前状态
            if (textContainer.classList.contains('mirror')) {
                mirrorBtn.textContent = '正常模式';
            } else {
                mirrorBtn.textContent = '镜像模式';
            }
        });
        
        // 打开本地文件
        openFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('文件太大，请选择小于10MB的文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                prompterText.textContent = content;
                inputText.value = content;
                setTimeout(calculateHeights, 100);
            };
            reader.onerror = function() {
                alert('读取文件时出错');
            };
            reader.readAsText(file);
        });
        
        // 更新文本内容
        inputText.addEventListener('input', function() {
            prompterText.textContent = this.value || "在这里输入您的文本。点击\"开始\"按钮开始滚动，使用速度滑块调整滚动速度。";
            setTimeout(calculateHeights, 100);
        });
        
        // 动画函数
        function animate() {
            position += speed / 10;
            updatePosition();
            
            if (isPlaying) {
                animationId = requestAnimationFrame(animate);
            }
        }
        
        // 改进的触摸事件处理
        teleprompterArea.addEventListener('touchstart', function(e) {
            const now = Date.now();
            
            // 双击检测
            if (now - lastTouchTime < 300) {
                touchCount++;
                if (touchCount === 2) {
                    if (isPlaying) pauseScrolling();
                    else startScrolling();
                    e.preventDefault();
                    touchCount = 0;
                    return;
                }
            } else {
                touchCount = 1;
            }
            lastTouchTime = now;
            
            if (isPlaying) pauseScrolling();
            
            touchStartY = e.touches[0].clientY;
            touchStartPosition = position;
            isTouchMoving = true;
            e.preventDefault();
        }, { passive: false });
        
        teleprompterArea.addEventListener('touchmove', function(e) {
            if (!isTouchMoving) return;
            
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - touchStartY;
            position = touchStartPosition - deltaY;
            
            updatePosition();
            e.preventDefault();
        }, { passive: false });
        
        teleprompterArea.addEventListener('touchend', function(e) {
            isTouchMoving = false;
            setTimeout(() => { touchCount = 0; }, 300);
            e.preventDefault();
        }, { passive: false });
        
        // 窗口调整和方向改变
        window.addEventListener('resize', function() {
            setTimeout(calculateHeights, 100);
        });
        
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                calculateHeights();
                updatePosition();
            }, 300);
        });
        
        function init() {
            adjustInitialFontSize();
            textContainer.style.height = '92%';
            setTimeout(calculateHeights, 500);
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
